# Nels-n-ATV
 
 

Разглобих 35 годишна съветска с дистанционно управление играчка "Луноход" и направих възможно тя да може да се контролира от компютър през Wi-fi модул (ESP 8266). Горната част на играчката е махната затова тя изглежда като танк (защото се предвижва чрез вериги) , но без купол.

__Как можете и Вие да направите същият проект?__

Ще се нуждаете от:
- Arduino Uno - 1 брой
- Wi-fi module ESP 8266 - 1 брой
- L9110 motor controller - 1 брой 
- Малък (или средно голям) акумулатор на 12 V, 7.5 Аh - 1 брой
- Играчка с шаси на танк, която използва вериги за предвиждване !(този проект няма да работи качествено ако играчката е  количка или нещо различно от играчка с вериги)! - 1 брой
- Breadboard за ардуиното - 1 брой
- Кабелчета мъжко-мъжко и мъжко-женско - >>ПО<< 15 броя (препоръчвам Ви малко повече от колкото Ви трябват)
- USB кабел за връзка с ардуиното - 1 брой 
- USB-UART adapter - 1 брой 
- Електролитен кондензатор - 10 uF над 24 V
- Да изтеглите Arduino IDE 
- Да си изтеглите Visual Studio code 

__1. Какво правим?

Ние имаме верижна играчка от тип "луноход" , "танк" и искаме да я управляваме чрез компютър през wi-fi модул. Каква точно става това?
Имаме wi-fi модул, ардуиното, мотор контролера и акумулатора ще бъдат върху играчката. Комуникацията е ще бъде следната: wi-fi модула се връзва към рутер, ние също се връзваме към него  и управляваме wi-fi модула чрез HTML файл ( ако не знаете какво представлява HTML файла не безпокойте ).



__Разяснения по проекта 

Първото най-важното нещо което трябва да знаете е : НЕ подавайте 5V за захранване на wi-fi модула ESP8266, защото както вече се досещате ще го изгорите и вече нищо няма да става от него, освен да Ви мирише на изгоряло. wi-fi модулът работи само  3,3 V. 

 Етапите през, които ще минем в правейки самият проект са:
 1. Конфигуриране Arduino IDE за работа с модула.
 2. Качване  firmware на wi-fi модула.
 3. Установяване връзка с него (тоест да можем да комуникираме с модула чрез AT команди ) и правенето необходимата   конфигурация на         модула  преди да качим "Code_for_arduino" в него.
 4. Свързване на схемата за да може да качи кода 
 5. Качването на   "Code_for_arduino" и променянето му за всеки индивидиално.
 6. Свързането на останалите елементи в схемата
 7. Да отворите файлът "controlling page" в папката"HTML page with javascript". От него ще управляваме играчката.
 
 __1. Конфигуриране Arduino IDE за работа с модула.
 
 1.1 Отворете вече изтегленият от Вас Arduino IDE от официланият сайт на arduino.cc: https://www.arduino.cc/en/Main/Software 
 1.2 Oтидете на file ---> preferences
 1.3 В полето "Additional boards manager URLs" копирайте този линк: http://arduino.esp8266.com/stable/package_esp8266com_index.json
 (Това ще Ви позволи в последствие да си ъпдейтнете библиотеките, с wi-fi модула  )
 1.4 Излезте от preferences и отидете в  tools ---> Board и изберете  "Arduino Uno", ако го няма избрано. 
 1.5 Отидете пак в tools--->Board "Arduino Uno"---> Boards Manager 
 1.6 Напишете в търсачката "esp8266" и си инсталирайте последната дадена възможна версия. (При мен на този етап е 2.7.1, но с времето ше дойдат и по-нови версий)
 
 
 __2. Качване firmware на Wi-fi модула.
 
 Това се налага поради факта, че когато си купите модула той Ви идва без firmware и Вие трябва да го качите сами. Firmware-а позволява устройството да може да се препограмирано чрез AT команди. Без него няма да можем да конфигурираме wi-fi модула, и съответно няма да можем да изградим комуникацията между устройствата, което е най-сложното и най-трудното нещо в този проект.
 
 Аз ще Ви преведа през стъпките, но ако има нещо не ясно моля погледнете този сайт : https://remotexy.com/en/help/esp8266-firmware-update/. Малко по-надолу има обяснено как да се направи качването на firmware чрез  USB-UART adapter и ние ще го направим също по този начин.
 
 2.1  Свържете USB-UART-а и ESP-то както е показано в файла  " Schematic for firmware update " , която съм качил в репозиторито.
 !  GPIO 0 трябва да бъде свързано към GND преди да включите USB-UART-та в компютъра  !
 2.2  Свалете файла: FLASH_DOWNLOAD_TOOLS_v2.4_150924 в репозиторито в него е програмата, която ни трябва за да ъпдейтнем  firmware-a. 
 2.3  Свалете файла:  esp8266_nonos_sdk_v1.4.0_15_09_18_0.rar и го разархивирайте 
 ! Важно: пътят до директориите и самите имена на на последните 2 файла, които свалихте трябва да са с английски имена на папките  !
 2.4 Отворете .еxe файла в FLASH_DOWNLOAD_TOOLS_v2.4_150924 , би трябвало да се появи същото, което съм качил като файл: 
     "updating the firmware - options", но като пуснете програмkaта директориите в полетата няма да бъдат избрани. 
     Това ще е и Вашата задача: да намерите по снимката файловете естествено по реда, в който са поставени, и да напишете същите адреси показани на снимката.
     Файлът  esp8266_nonos_sdk_v1.4.0_15_09_18_0 ще го намерите ето на този линк:  https://drive.google.com/file/d/0B25ZKkkYCPJbVGR1VHZOVmVvWjA/view
     Например: Разархивирайте го и в папка bin да намерете  пътя до файла  esp_init_data_default.bin и да го кликнете. После в адресното поле от дясно трябва променяте и адресът както е показан на снимката: 
"0xFC000"
Всички файлове, които трябва да намерите са в подпапка bin в esp8266_nonos_sdk_v1.4.0_15_09_18_0, като последните 2 ще ги намерите в поддирикторията на bin  в at/512+512
2.5 Конфигурирайте показаната конфигурация, за качване на firmware-а, както е показано на снимката:
- SPIAutoSet — set;
- CrystalFreq - 26M;
- FLASH SIZE – 8Mbit or 16Mbit depending on the size of the flash memory;
- COM PORT – select the port that is connected to ESP;
- SPI SPEED - 40MHz
- SPI MODE - QIO
- COP PORT - избирате този към, който сте включили wi-fi модула (тоест може и да не е COM 3, а да някой друг порт)
- BAUDRATE – 115200
2.6 Кликнете "Start" 
  Ako програмката не тръгне:
  - Проверете дали сте свързали GPIO 0 към ПРЕДИ да сте свързали USB-UART-та към компютъра.
  Ако сте свързали GPIO 0 по време когато схемата е работила, wi-fi модула няма да отчете това и няма да можете да го вкарате в режим  
  "update the firmware"
  - Прoверете отново дали конфигурацията Ви е правилна и дали BAUDRATE e зададен да бъде 115200
  
 __3. Установяване връзка с него (тоест да можем да комуникираме с модула чрез AT команди ) и правенето необходимата   конфигурация на         модула  преди да качим "Code_for_arduino" в него.
  
  
 3.1 След като приключи update-а, откачете USB-UART-a от компютъра и GPIO 0 от GND
 3.2 Включете USB-UART-a пак, пуснете програмката Arduino IDE и сериал port монитора (малката лупичка горе вдясно)
     BAUDRATE-та трябва да Ви бъде  115200 и да бъде избрана опцията "Both NL & CR "
 3.3 Проверете дали АТ командите раборят като въведете в празното поле горе командата "AT"
     Ако Ви изпише в последствие OK значи всичко е наред.
     AT командите позволяват едно устройство да бъде конфигурирано по начин, по който потребителят иска. Те ни позволяват да       конфигурираме самият модул. Ако имате желание да разгледате тези команди и какво прави всяка от тях, можете да видите оттук:
  https://www.espressif.com/sites/default/files/documentation/4a-esp8266_at_instruction_set_en.pdf
Попринцип ако една AT команда не Ви работи има 4 варианта:
- Не сте я написали правилно
- Не сте и задали броят параметри, която самата команда изисква
- АТ командата не е съвместима с версията на firmware-а на модула и той не я разпознава 
- Самата команда не може да бъде изпълнена, поради това  че зададената от преди вече конфигурация от Вас прави изпълнението на въведена  команда невъзможно.

3.4 Въведете горе в полето : "AT+UART_DEF=9600,8,1,0,0" -по този начин конфигурираме модула да работи на 9600 baudrate вместо зададените му по default 115200. Тази стъпка е необходима да се направи, защото ние ще  използваме серийна комуникация между ардуиното и модула, а тя работи на 9600. 

3.5 В сериал монитора изберете комуникацията вече да бъде 9600 и изкрайте и вкарайте USB-то.
     За да тествате дали пак работи напишете АТ и ако Ви изпише отдолу ОК значи всичко е наред.
3.6 Конфигурайте IP адреса на модула:
     Напишете командата: "AT+CIPSTA_DEF="192.168.1.202""
     
__4. Свързване на схемата ( това не е пълната схема, по-нататък ще направим я цялата)

Досега конфигурирахме Wi-fi  модула с помощта на USB-UART. Сега е време да изградим схемата, с която ще работим.
В репозирито съм качил файл с име "Tank controller schematic 1". В нея са свързани само ардуиното и wi-fi модула. В схемата не е показано, НО свържете кондезатор описан по-рано в между GND и 3.3 V-ta. Той е много важен и без него ESP-то само ще се рестартира отното и отново.  Идята е първо да направим схемата, за да може кодът да се качи в ардуиното, впоследствие да направим цялата схема.  Отворете го и свържето ардуиното и ESP-to както е показано.

__5. Качването на   "Code_for_arduino" и променянето му за всеки индивидиално. 

След като вече сте свързали схемата по указаният начин:
5.1 Свържете USB кабела към ардуиното и копирайте кодът "Code_for_arduino" и го поставете в Arduino IDE програмката.
5.2. Копирайте кода от Code_for_arduino и го сложете в Arduino IDE (програмата )
5.3 Намерете редът, на който пише:
    esp8266Serial("AT+CWJAP_DEF=\"Tuborg 68\",\"12345\"\r\n", 5000, DEBUG);//Enter your WiFi network's SSID and Password.
5.4 Променете "Tuborg 68" с името на Вашата мрежа у Вас, както и на мястото на 12345 напишете паролата за Вашата мрежа.
5.2 Ъплоуднете кода 
    Ако Ви изпише че има грешка си проверете порта, на който се вързали ардуиното и дали на този, който ъплоудвате кода са едни и същи.
5.3 Откачете ардуиното от компютъра

__6.Свързането на останалите елементи в схемата.

   В репозиторите съм качил файл с име "Tank_controller_2". За разлика от предишната тук добавяме към схемата акумулатора, мотор контролера, и ел.двигателите на играчката.
    ! Сложете акумулаторът последен в схемата !
   След като се сигурни, че свързали  схемата правилно свържете ардуиното към компютъра си.
   Отворете сериал монитора, би трябвало да Ви изпише това което показано в "serial monitor of the program" като АТ команди. Ако Ви        показва това, което е на снимката значи всичко е наред. Естествено мрежата и паролата ще се различни за всеки от Вас.
   
 __7. Управляването на играчката през wi-fi модула
 Свалете  папката"HTML page with javascript" и отворете  файлът "controlling page" . От него ще управляваме играчката.
 В празното поле напишете IP адресът на модула, който заедно с Вас конфигурихрахме да бъде : 192.168.1.202 и цъкнете бутонът взависимост от това какво искате да направи играчката 
 
 Поздравления Вие вече можете да управлявате играчката през своят компютър :-). Нядавам се този tutorial да Ви е бил полезен.
